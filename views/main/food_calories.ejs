<%- include('../components/header/website_header.ejs',{cssFile : 'index',page:page}) %> 

<div id="load"></div>

<div class="modal fade" id="searchFood" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-body">
                <div id="close" data-bs-dismiss="modal">
                    <a><span class="iconify" data-icon="eva:close-fill"></span></a>
                </div>
                <div class="calorie">
                    <div class="date">
                        <p>Search Your Food</p>
                    </div>
                    <div class="form-group input-group search" style="margin:20px 0px 10px 0px;height: 50px !important;">
                        <a style="width: 45px !important;"><span class="iconify" data-icon="akar-icons:search"></span></a>
                        <input type="text" class="form-control" id="searchText" onkeyup="searchFood(this.value)" style="background-color: var(--white);" name="searchedTitle" placeholder="Search by food name..." autocomplete="off">
                    </div>
                    <div class="items" style="padding: 10px 0px 0px 0px !important;" id="foodContent">

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="main-container">
    <br><br><br><br>
    <div class="container">
        <div class="row d-flex align-items-center">
            <div class="col-lg-9 col-md-8 col-sm-4 col-12" style="padding: 0px 0px 0px 10px !important;">
                <div class="heading">
                    <h5>Total food calories (<span id="totalValue">0 kacl</span>)</h5>
                    <p>See all the your eaten calories here.</p>
                </div>
            </div>
            <div class="col-lg-3 col-md-4 col-sm-8 col-12" style="padding: 0px 10px 0px 10px !important;">
                <div class="date">
                    <input type="date" id="currentDateFood" class="form-control" onchange="getCalorieCounterData()" name="SelectedDate" value="Today"/>
                </div>
            </div>
        </div>
        <br>
        <div class="row" id="cartTotal">
            <div class="col-lg-6 col-md-6 col-sm-12 col-12 order-1 order-md-0" style="padding: 0px 10px 0px 10px !important;" id="cartItems">
                <div class="accordion-item meal-card">
                    <h2 class="accordion-header" id="panelsStayOpen-headingOne">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapseOne" aria-expanded="false" aria-controls="panelsStayOpen-collapseOne">
                        <span>
                            <img src="/images/local/breakfast.png">
                        </span>
                        <span>Breakfast<br><span class="totalCalories" id="breakfastValue">0 kacl</span></span>
                      </button>
                    </h2>
                    <div id="panelsStayOpen-collapseOne" class="accordion-collapse collapse" aria-labelledby="panelsStayOpen-headingOne">
                      <div class="items" id="breakFastItems">
                        
                      </div>
                    </div>
                </div>
                <div class="accordion-item meal-card">
                    <h2 class="accordion-header" id="panelsStayOpen-headingTwo">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapseTwo" aria-expanded="false" aria-controls="panelsStayOpen-collapseTwo">
                        <span>
                            <img src="/images/local/snacks.png">
                        </span>
                        <span>Snacks<br><span class="totalCalories" id="snacksValue">0 kacl</span></span>
                      </button>
                    </h2>
                    <div id="panelsStayOpen-collapseTwo" class="accordion-collapse collapse" aria-labelledby="panelsStayOpen-headingTwo">
                        <div class="items" id="snacksItems">
                        
                        </div>
                    </div>
                  </div>
                  <div class="accordion-item meal-card">
                    <h2 class="accordion-header" id="panelsStayOpen-headingThree">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapseThree" aria-expanded="false" aria-controls="panelsStayOpen-collapseThree">
                        <span>
                            <img src="/images/local/lunch.png">
                        </span>
                        <span>Lunch<br><span class="totalCalories" id="lunchValue">0 kacl</span></span>
                      </button>
                    </h2>
                    <div id="panelsStayOpen-collapseThree" class="accordion-collapse collapse" aria-labelledby="panelsStayOpen-headingThree">
                        <div class="items" id="lunchItems">
                        
                        </div>
                    </div>
                  </div>
                  <div class="accordion-item meal-card">
                    <h2 class="accordion-header" id="panelsStayOpen-headingFour">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapseFour" aria-expanded="false" aria-controls="panelsStayOpen-collapseFour">
                        <span>
                            <img src="/images/local/dinner.png">
                        </span>
                        <span>Dinner<br><span class="totalCalories" id="dinnerValue">0 kacl</span></span>
                      </button>
                    </h2>
                    <div id="panelsStayOpen-collapseFour" class="accordion-collapse collapse" aria-labelledby="panelsStayOpen-headingFour">
                        <div class="items" id="dinnerItems">
                        
                        </div>
                    </div>
                  </div>
            </div>
            <div class="col-lg-6 col-md-6 col-sm-12 col-12 order-0 order-md-1" id="final_price" style="padding: 0px 10px 0px 10px !important;">
                <div class="final_price card" style="margin-bottom: 20px">
                    <div class="total">
                        <h5>Add new entry</h5>
                    </div>
                    <div class="form-group search" style="margin:20px 0px 10px 0px;height: 50px !important;border-radius: 10px !important;">
                        <input type="text" class="form-control" onclick="openSearchFoodModal()" style="background-color: var(--white);height: 100% !important;border: 0.5px solid var(--default-input-borders) !important;border-radius: 10px !important;"  placeholder="Click here to add food ..." readonly value="">
                    </div>
                    <div class="selectedValue" id="selectedFood" data-foodId="0" data-foodCalories="0">
                        
                    </div>
                    <form onsubmit="addFood(event)" id="form" method="post" autocomplete="off">
                        <div class="row">
                            <input type="hidden" name="food_id" id="food_id">
                            <div class="col-lg-12 col-md-12 col-sm-12 col-12">
                                <div class="form-group">
                                    <label for="meal" style="margin:0px 0px 10px 0px;">Meal</label>
                                    <select class="form-control" id="meal" name="meal" aria-label="Images Categories" required>
                                        <option value="BREAKFAST">BREAKFAST</option>
                                        <option value="SNACKS">SNACKS</option>
                                        <option value="LUNCH">LUNCH</option>
                                        <option value="DINNER">DINNER</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-lg-12 col-md-12 col-sm-12 col-12" style="padding-right: 0px !important;">
                                <label for="servings" style="margin:10px 0px 10px 0px;">Servings</label>
                                <div class="form-group input-group">
                                    <input type="number" step=0.01 class="form-control" name="servings" id="servings" placeholder="Enter no. of servings" style="border-radius: 10px;" required/>
                                    <a style="background-color: var(--card-bg);border-radius: 0px 10px 10px 0px;display: flex;align-items: center;" id="unit"></a>
                                </div>
                            </div>
                            <div class="button" style="padding: 0;">
                                <button type="submit" id="food_verify" class="btn btn-primary d-flex justify-content-center" style="width: 100%;margin-top: 20px;">Add</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <br><br>
    <%- include('footer.ejs',{showContactExpert: true}) %>
</div>

<script>

var date = '<%- date %>';
    var isDevelopment = '<%- isDevelopment %>' == 'true' ? true : false;
    var waitTime = 1500;

var addFoodModal;
    $(function(){
        addFoodModal = new bootstrap.Modal(document.getElementById('searchFood'));
    });

    function openSearchFoodModal() {
        var value = document.getElementById('selectedFood').innerHTML;
        if(value.trim().length == 0){
            addFoodModal.toggle();
        } else {
            alert('First remove the selected food item');
        }
    }

function searchFood(value) {
    clearTimeout(timer);
    var timer = setTimeout(() => {
        search(value);
    },waitTime);
}

function search(value) {
    if(value.length != 0) {
        var array = document.cookie.split(';');
        var counter = 0;
        var index = 0;
        var userIndex = 0;
        for(var i=0;i<array.length;i++) {
            if(array[i].includes('currentUserToken=')){
                counter++;
                index = i;
            }
            if(array[i].includes('user_id=')){
                counter++;
                userIndex = i;
            }
        }
        if(decodeURIComponent(document.cookie).split(';')[index].split('currentUserToken=')[1]) {
            var token = decodeURIComponent(document.cookie).split(';')[index].split('currentUserToken=')[1];
            var user_id = decodeURIComponent(document.cookie).split(';')[userIndex].split('user_id=')[1];
        } else {
            var token = document.cookie.split(';')[index].split('currentUserToken=')[1];
            var user_id = document.cookie.split(';')[userIndex].split('user_id=')[1];
        }
        // document.getElementById('load').style.visibility="visible";
        document.getElementById('foodContent').innerHTML = '';
        document.getElementById('selectedFood').innerHTML = '';
        $.ajax({
            url : `/api/getSearchFood?searchedTitle=${value}`,
            dataType: "json",
            type: "GET",
            headers: {
                'token':token ? token : 'testing',
                'Content-Type':'application/json',
                'platform': 'WEB'
            },
            success: function(response){
                    if(isDevelopment) {
                    console.log(response);
                }
              if(response.data.length !=0){
                for(var i = 0;i<response.data.length;i++) {
                    $('#foodContent').append('<div onclick="onSelectFoodItem(\''+ response.data[i].name +'\',\''+ response.data[i].cover_photo +'\',\''+ response.data[i].quantity +'\',\''+ response.data[i].units +'\',\''+ response.data[i].calories +'\',\''+ response.data[i].protein +'\',\''+ response.data[i].carbs +'\',\''+ response.data[i].fats +'\',\''+ response.data[i].fiber +'\',\''+ response.data[i].id +'\')" class="item"><div class="image"><img src="'+ response.data[i].cover_photo +'" alt=""></div><div class="content"><div class="name"><p>'+ response.data[i].name +' (1 serving = '+ response.data[i].quantity +''+ response.data[i].units +')</p><p>'+ response.data[i].calories +' kcal</p></div></div></div>');
                }
              } else {
                document.getElementById('foodContent').innerHTML = '<div class="col-12 text-center"><h6>No item available</h6></div>';
              }
            //   document.getElementById('load').style.visibility="hidden";
            },
            error: function(err){
                if(isDevelopment) {
                    console.log(err);
                }
                alert('Some error occured !!');
            }
        });
    } else {
        document.getElementById('foodContent').innerHTML = '';
    }
}

function onSelectFoodItem(name,cover_photo,quantity,units,calories,protein,carbs,fats,fiber,id) {
    document.getElementById('selectedFood').setAttribute('data-foodId',id);
    document.getElementById('selectedFood').setAttribute('data-foodCalories',calories);
    document.getElementById('servings').style.borderRadius = '10px 0px 0px 10px';
    document.getElementById('unit').style.padding = '0px 10px';
    document.getElementById('unit').innerHTML = `* ${quantity} ${units}`;
    $('#selectedFood').append('<div class="item"><div class="top"><div class="image"><img src="'+ cover_photo +'" alt=""></div><div class="content"> <div class="name"><p>'+ name +' (1 serving = '+ quantity +''+ units +')</p><p>'+ calories +' kcal</p></div><div id="delete-icon3" onclick="removeSelectedFoodItem()" style="margin-left: 10px;"><a><span class="iconify" data-icon="ant-design:delete-outlined"></span></a></div></div></div><hr><div class="details"><div class="detail"><p>Protein</p><p>'+ protein +'g</p></div><div class="detail"><p>Carbs</p><p>'+ carbs +'g</p></div><div class="detail"><p>Fats</p><p>'+ fats +'g</p></div><div class="detail"><p>Fiber</p><p>'+ fiber +'g</p></div></div></div>');
    document.getElementById('searchText').value = '';
    document.getElementById('foodContent').innerHTML = '';
    addFoodModal.toggle();
}

function removeSelectedFoodItem() {
    if(confirm('Are you sure you want to remove selected food item?') == true){
        document.getElementById('selectedFood').innerHTML = '';
        document.getElementById('servings').style.borderRadius = '10px';
        document.getElementById('unit').style.padding = '0px';
        document.getElementById('unit').innerHTML = '';
    }
}

function removeFromUserFoodCalories(id) {
    if(confirm('Are you sure you want to remove this data?') == true){
        document.getElementById('load').style.visibility="visible";
        var array = document.cookie.split(';');
        var counter = 0;
        var index = 0;
        var userIndex = 0;
        for(var i=0;i<array.length;i++) {
            if(array[i].includes('currentUserToken=')){
                counter++;
                index = i;
            }
            if(array[i].includes('user_id=')){
                counter++;
                userIndex = i;
            }
        }
        if(decodeURIComponent(document.cookie).split(';')[index].split('currentUserToken=')[1]) {
            var token = decodeURIComponent(document.cookie).split(';')[index].split('currentUserToken=')[1];
            var user_id = decodeURIComponent(document.cookie).split(';')[userIndex].split('user_id=')[1];
        } else {
            var token = document.cookie.split(';')[index].split('currentUserToken=')[1];
            var user_id = document.cookie.split(';')[userIndex].split('user_id=')[1];
        }
        $.ajax({
            url : `/api/removeFromUserFoodCalories`,
            dataType: "json",
            type: "POST",
            headers: {
                'token':token ? token : 'testing',
                'platform': 'WEB'
            },
            data:{
                id: id,
            },
            success: function(response){
                if(isDevelopment) {
                    console.log(response);
                }
                if(response.message == 'success') {
                    location.reload();
                }
            },
            error: function(err){
                if(isDevelopment) {
                    console.log(err);
                }
                alert('Some error occured !!');
              document.getElementById('load').style.visibility="hidden";
            }
        });
    }
}

//Add food
function addFood(event) {
    event.preventDefault();
    var value = document.getElementById('selectedFood').innerHTML;
    var newDate = document.getElementById('currentDateFood').value;
    if(value.trim().length != 0){
        document.getElementById('load').style.visibility="visible";
        var array = document.cookie.split(';');
        var counter = 0;
        var index = 0;
        var userIndex = 0;
        for(var i=0;i<array.length;i++) {
            if(array[i].includes('currentUserToken=')){
                counter++;
                index = i;
            }
            if(array[i].includes('user_id=')){
                counter++;
                userIndex = i;
            }
        }
        if(decodeURIComponent(document.cookie).split(';')[index].split('currentUserToken=')[1]) {
            var token = decodeURIComponent(document.cookie).split(';')[index].split('currentUserToken=')[1];
            var user_id = decodeURIComponent(document.cookie).split(';')[userIndex].split('user_id=')[1];
        } else {
            var token = document.cookie.split(';')[index].split('currentUserToken=')[1];
            var user_id = document.cookie.split(';')[userIndex].split('user_id=')[1];
        }
        var food_id = document.getElementById('selectedFood').getAttribute('data-foodId');
        var foodCalories = document.getElementById('selectedFood').getAttribute('data-foodCalories');
        var meal = document.getElementById('meal').value;
        var unit = document.getElementById('unit').value;
        var servings = document.getElementById('servings').value;
        var calories = parseFloat(foodCalories)*parseFloat(servings);

        $.ajax({
            url : '/api/addFood',
            dataType: "json",
            type: "POST",
            data: {
                user_id:user_id,
                food_id:food_id,
                meal:meal,
                unit:unit,
                servings:servings,
                calories:calories,
                date:newDate + ' 00:00:00'
            },
            success: function(response){
                location.reload();
            },
            error: function(err){
                if(isDevelopment) {
                    console.log(err);
                }
                alert('Some error occured !!');
            }
        });
    } else {
            alert('Please select a food item first');
    }
  }

    function getCalorieCounterData() {
        var newDate = document.getElementById('currentDateFood').value;
        // getFoodCalorieData(newDate);
        window.location.href = `/food_calories?date=${newDate}`;
    }
    
    function getFoodCalorieData(date) {
        document.getElementById('currentDateFood').value = date;
        var array = document.cookie.split(';');
        var counter = 0;
        var index = 0;
        var userIndex = 0;
        for(var i=0;i<array.length;i++) {
            if(array[i].includes('currentUserToken=')){
                counter++;
                index = i;
            }
            if(array[i].includes('user_id=')){
                counter++;
                userIndex = i;
            }
        }
        if(decodeURIComponent(document.cookie).split(';')[index].split('currentUserToken=')[1]) {
            var token = decodeURIComponent(document.cookie).split(';')[index].split('currentUserToken=')[1];
            var user_id = decodeURIComponent(document.cookie).split(';')[userIndex].split('user_id=')[1];
        } else {
            var token = document.cookie.split(';')[index].split('currentUserToken=')[1];
            var user_id = document.cookie.split(';')[userIndex].split('user_id=')[1];
        }
        document.getElementById('load').style.visibility="visible";
        document.getElementById('breakFastItems').innerHTML = '';
        document.getElementById('lunchItems').innerHTML = '';
        document.getElementById('dinnerItems').innerHTML = '';
        document.getElementById('snacksItems').innerHTML = '';
        $.ajax({
            url : `/api/getFoodCalorieData?user_id=${user_id}&date=${date}`,
            dataType: "json",
            type: "GET",
            headers: {
                'token':token ? token : 'testing',
                'Content-Type':'application/json',
                'platform': 'WEB'
            },
            success: function(response){
              if(isDevelopment) {
                    console.log(response);
                }
              var breakfast = 0;
                    var snacks = 0;
                    var lunch = 0;
                    var dinner = 0;
                    var total = 0;
                    for(var i = 0;i<response.user_calories.length;i++) {
                        if(response.user_calories[i].meal == 'BREAKFAST') {
                            breakfast = breakfast + response.user_calories[i].calories;
                            $('#breakFastItems').append('<div class="item"><div class="image"><img src="'+ response.user_calories[i].cover_photo +'" alt=""></div><div class="content"><div class="name"><p>'+ response.user_calories[i].name +' ('+ response.user_calories[i].servings +' servings)</p><p>'+ response.user_calories[i].calories +' kcal</p></div><div id="delete-icon3" onclick="removeFromUserFoodCalories(\''+ response.user_calories[i].id +'\')" style="margin-left: 10px;"><a><span class="iconify" data-icon="ant-design:delete-outlined"></span></a></div></div></div>');
                        }
                        if(response.user_calories[i].meal == 'LUNCH') {
                            lunch = lunch + response.user_calories[i].calories;
                            $('#lunchItems').append('<div class="item"><div class="image"><img src="'+ response.user_calories[i].cover_photo +'" alt=""></div><div class="content"><div class="name"><p>'+ response.user_calories[i].name +' ('+ response.user_calories[i].servings +' servings)</p><p>'+ response.user_calories[i].calories +' kcal</p></div><div id="delete-icon3" onclick="removeFromUserFoodCalories(\''+ response.user_calories[i].id +'\')" style="margin-left: 10px;"><a><span class="iconify" data-icon="ant-design:delete-outlined"></span></a></div></div></div>');
                        }
                        if(response.user_calories[i].meal == 'DINNER') {
                            dinner = dinner + response.user_calories[i].calories;
                            $('#dinnerItems').append('<div class="item"><div class="image"><img src="'+ response.user_calories[i].cover_photo +'" alt=""></div><div class="content"><div class="name"><p>'+ response.user_calories[i].name +' ('+ response.user_calories[i].servings +' servings)</p><p>'+ response.user_calories[i].calories +' kcal</p></div><div id="delete-icon3" onclick="removeFromUserFoodCalories(\''+ response.user_calories[i].id +'\')" style="margin-left: 10px;"><a><span class="iconify" data-icon="ant-design:delete-outlined"></span></a></div></div></div>');
                        }
                        if(response.user_calories[i].meal == 'SNACKS') {
                            snacks = snacks + response.user_calories[i].calories;
                            $('#snacksItems').append('<div class="item"><div class="image"><img src="'+ response.user_calories[i].cover_photo +'" alt=""></div><div class="content"><div class="name"><p>'+ response.user_calories[i].name +' ('+ response.user_calories[i].servings +' servings)</p><p>'+ response.user_calories[i].calories +' kcal</p></div><div id="delete-icon3" onclick="removeFromUserFoodCalories(\''+ response.user_calories[i].id +'\')" style="margin-left: 10px;"><a><span class="iconify" data-icon="ant-design:delete-outlined"></span></a></div></div></div>');
                        }
                    }
                    total = breakfast + dinner + snacks + lunch;
                    document.getElementById('breakfastValue').innerHTML = `${breakfast} kcal`;
                    document.getElementById('snacksValue').innerHTML = `${snacks} kcal`;
                    document.getElementById('lunchValue').innerHTML = `${lunch} kcal`;
                    document.getElementById('dinnerValue').innerHTML = `${dinner} kcal`;
                    document.getElementById('totalValue').innerHTML = `${total} kcal`;
              document.getElementById('load').style.visibility="hidden";
            },
            error: function(err){
                if(isDevelopment) {
                    console.log(err);
                }
                alert('Some error occured !!');
            }
        });
    }
    setTimeout(() => {
        getFoodCalorieData(date);
    },500);
</script>
<%- include('../components/footer/website_footer.ejs') %>