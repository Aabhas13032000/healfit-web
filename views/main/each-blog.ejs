<%- include('../components/header/website_header.ejs',{cssFile : 'index',page:page}) %> 

<div id="load"></div>

<!-- Link Modal -->
<div class="modal fade" id="commentModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Comments</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
        <div class="modal-body">
          <div class="commentContent" id="commentContent" data-commentId="0" data-totalComments="0" onscroll="getMoreBlogComments()">
            
          </div>
          <div class="commentInput">
            <div class="form-group input-group search">
                <input type="text" class="form-control" style="border: 0;height: 100%;border-radius: 10px 0px 0px 10px !important;" name="message" id="message" placeholder="Write your comment here..."/>
                <a onclick="addMessage()"><span class="iconify" data-icon="fluent:send-16-regular"></span></a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<div class="main-container">
    <br><br><br>
    <div class="container eachblogContainer">
        <div class="row">
            <div class="col-12">
                <div class="profileImage" id="profileImage">
                    <div id="carouselExampleSlidesOnly" class="carousel slide" data-bs-ride="carousel">
                        <div class="carousel-inner" id="profile-slider">
                        </div>
                      </div>
                </div>
            </div>
            <div class="col-12">
                <div class="title" id="title">

                </div>
                <div class="info" id="info">
                    
                </div>
            </div>
            <div class="col-12">
                <div class="description" id="description">

                </div>
            </div>
            <div class="col-12" id="similiarBlogs">
                <br>
                <div class="heading" id="heading">
                    <h5>More blogs to read</h5>
                </div>
                <br>
                <div class="row experts" id="moreBlogs">
                    
                </div>
            </div>
        </div>
    </div>
    <br><br><br>
    <%- include('footer.ejs',{showContactExpert: true}) %>
</div>

<!-- Link Modal -->
<div class="modal fade" id="sendingNotification" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body">
          <h3>Generating Share Link, Please Wait!!</h3>
        </div>
      </div>
    </div>
  </div>

<script>
    var isDevelopment = '<%- isDevelopment %>' == 'true' ? true : false;
    
    function getEachTrainer() {
        var array = document.cookie.split(';');
        var counter = 0;
        var index = 0;
        var userIndex = 0;
        for(var i=0;i<array.length;i++) {
            if(array[i].includes('currentUserToken=')){
                counter++;
                index = i;
            }
            if(array[i].includes('user_id=')){
                counter++;
                userIndex = i;
            }
        }
        if(decodeURIComponent(document.cookie).split(';')[index].split('currentUserToken=')[1]) {
            var token = decodeURIComponent(document.cookie).split(';')[index].split('currentUserToken=')[1];
            var user_id = decodeURIComponent(document.cookie).split(';')[userIndex].split('user_id=')[1];
        } else {
            var token = document.cookie.split(';')[index].split('currentUserToken=')[1];
            var user_id = document.cookie.split(';')[userIndex].split('user_id=')[1];
        }
        document.getElementById('load').style.visibility="visible";
        document.getElementById('title').innerHTML = '';
        document.getElementById('info').innerHTML = '';
        document.getElementById('description').innerHTML = '';
        document.getElementById('moreBlogs').innerHTML = '';
        // document.getElementById('views').innerHTML = '';
        // document.getElementById('date').innerHTML = '';
        document.getElementById('profile-slider').innerHTML = '';
        var id = '<%- id %>';
        $.ajax({
            url : `/api/blogs/getEachBlog?id=${id}&user_id=${user_id}`,
            dataType: "json",
            type: "GET",
            headers: {
                'token':token ? token : 'testing',
                'Content-Type':'application/json',
                'platform': 'WEB'
            },
            success: function(response){
              if(isDevelopment) {
                    console.log(response);
                }
                var color;
                var icon;
                if(response.data[0].isLiked == 1) {
                    color = 'var(--highlight)';
                    icon = 'bxs:like';
                } else {
                    color = 'var(--sub-text)';
                    icon = 'bx:like';
                }
                document.getElementById('title').innerHTML = '<h2>'+ response.data[0].title +'</h2>';
                document.getElementById('description').innerHTML = response.data[0].description;
                // document.getElementById('views').innerHTML = response.data[0].views;
                // document.getElementById('date').innerHTML = response.data[0].created_at.slice(0,10);
                document.getElementById('info').innerHTML = '<p class="date" style="margin:0 !important">'+ response.data[0].created_at.slice(0,10) +'</p><p class="downloads" onclick="likeDislike(\''+ response.data[0].id +'\')" style="color: '+ color +'" data-liked="'+ response.data[0].isLiked +'" id="icon_update_'+ response.data[0].id +'"><span class="iconify" id="icon_to_update_'+ response.data[0].id +'" style="height:20px;width:20px" data-icon="'+ icon +'"></span>&nbsp;&nbsp;<span id="total_likes_'+ response.data[0].id +'">'+ response.data[0].totalLikes +'</span></p><p class="date"><span class="iconify" style="height:20px;width:20px" data-icon="akar-icons:comment" onclick="getComments(\''+ response.data[0].id +'\',0)"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="iconify" style="height:20px;width:20px" data-icon="ci:share" onclick="generateShareLink(\''+ response.data[0].id +'\',\'blog\',\''+ ('/each-blog/'+ response.data[0].id +'?item_id='+ response.data[0].id +'') +'\',\''+ response.data[0].share_url +'\')"></span></p>';
              if(response.images.length !=0) {
                    for(var i=0;i<response.images.length;i++){
                        if(i == 0) {
                            $('#profile-slider').append('<div class="carousel-item active"><img src="'+ response.images[i].path +'" class="d-block w-100" alt=""></div>');
                        } else {
                            $('#profile-slider').append('<div class="carousel-item"><img src="'+ response.images[i].path +'" class="d-block w-100" alt=""></div>');
                        }
                    }
                } else {
                    document.getElementById('profileImage').innerHTML  = '';
                    document.getElementsByClassName('profileImage')[0].style.height  = '0px !important';
                }
                if(response.moreBlogs.length !=0) {
                    for(var i=0;i<response.moreBlogs.length;i++){
                        var description = response.moreBlogs[i].description;
                        var desc = description.replace(/<[^>]+>/g, '');
                        var color;
                        var icon;
                        if(response.moreBlogs[i].isLiked == 1) {
                            color = 'var(--highlight)';
                            icon = 'bxs:like';
                        } else {
                            color = 'var(--sub-text)';
                            icon = 'bx:like';
                        }
                        $('#moreBlogs').append('<div class="col-lg-4 col-md-4 col-sm-6 col-12"><div class="box2" style="background-image: url(\''+ response.moreBlogs[i].cover_photo +'\');margin: 0;"><div class="inside_container"><div onclick="window.location.href=\'/each-blog/'+ response.moreBlogs[i].id +'\'"><p class="date">'+ response.moreBlogs[i].created_at.toString().slice(0,10) +'</p><h5>'+ response.moreBlogs[i].title +'</h5><p>'+ desc +'</p></div><div class="info"><p class="downloads" onclick="likeDislike(\''+ response.moreBlogs[i].id +'\')" style="color: '+ color +'" data-liked="'+ response.moreBlogs[i].isLiked +'" id="icon_update_'+ response.moreBlogs[i].id +'"><span class="iconify" id="icon_to_update_'+ response.moreBlogs[i].id +'" data-icon="'+ icon +'"></span>&nbsp;&nbsp;<span id="total_likes_'+ response.moreBlogs[i].id +'">'+ response.moreBlogs[i].totalLikes +'</span></p><p class="date"><span class="iconify" data-icon="akar-icons:comment" onclick="getComments(\''+ response.moreBlogs[i].id +'\',0)"></span>&nbsp;&nbsp;<span class="iconify" data-icon="ci:share" onclick="generateShareLink(\''+ response.moreBlogs[i].id +'\',\'blog\',\''+ ('/each-blog/'+ response.moreBlogs[i].id +'?item_id='+ response.moreBlogs[i].id +'') +'\',\''+ response.moreBlogs[i].share_url +'\')"></span></p></div></div></div></div>');
                    }
                } else {
                    document.getElementById('similiarBlogs').style.display = 'none';
                }
              document.getElementById('load').style.visibility="hidden";
            },
            error: function(err){
                if(isDevelopment) {
                    console.log(err);
                }
                alert('Some error occured !!');
            }
        });
    }
    setTimeout(() => {
        getEachTrainer();
    },500);
</script>

<%- include('../components/footer/website_footer.ejs') %>